---
title: "Analyses for latent-network/confirmatory factor analysis/ Exploratory graph analysis paper"
author: "Or Duek, Tobias R. Spiller & Karen-Inge Karstoft"
output:
html_document:
df_print: paged
---
  
##############################################################################
#									                                                                   #
#                 Factor vs (Latent) Network models of PTSD                  #
#                                                                            #
#                       Code Version 0.1.2 (29.01.2020)                      #
#                                                                            #
##############################################################################


## Table of Contents
#----- 1. Load libraries ----------------------------------------------------#
#----- 2. Import and prepare data  & descriptives ---------------------------#
#----- 3. Compare different estimation techniques ---------------------------#
#----- 4. Estiamte Networks incl. centrality and stability analyses ---------#
#----- 5. Community Analysis ------------------------------------------------#
#----- 6. Confirmatory  Analyses --------------------------------------------#
#----- 7. Session infos -----------------------------------------------------#
#----- 8. Open Questions ----------------------------------------------------#


## 1. Load libraries ####
```{r}
# Data handeling
if(!require("tidyverse")) install.packages("tidyverse")
if(!require("corrplot")) install.packages("corrplot") 
if(!require("OpenMX")) install.packages("OpenMx") 

# Network packages
if(!require("qgraph")) install.packages("qgraph")
if(!require("psychonetrics")) install.packages("psychonetrics")
if(!require("bootnet")) install.packages("bootnet")
if(!require("mgm")) install.packages("mgm")
if(!require("networktools")) install.packages("networktools")
if(!require("EGAnet")) install.packages("EGAnet")

# SEM
if(!require("lavaan")) install.packages("lavaan")

# Additional packages
if(!require("rtf")) install.packages("rtf")
```
<br/>
<br/>
## 2. Import and prepare data  & descriptives ####
#### this is the DSM-IV dataset (big data)
```{r}
# load data set
source('/home/or/Documents/va_data/readData.r')
```

#### Data cleanning and descriptive statistics
```{r}

# all patientes with PTSD and PCLTOT
pclAll <- dplyr::filter(vaDatclean, !is.na(BPCLTOT))
# plot pcl total score 
hist(pclAll$BPCLTOT)
# we have a minimum of 2 - so we have some NAs - let remove them
pclAll_Nas <- filter(pclAll, BPCLTOT <=16)
# total of 20 subjects with 16 or less in PCL (i.e. at least one missing variable)
# we can remove them from analysis
pclAll <- filter(pclAll, BPCLTOT >=17)
# 159577 patients
#pclNetwork <- pclNoNa # just medicated
pclNetwork <- pclAll
nrow(pclNetwork)
hist(pclNetwork$BPCLTOT)
```

#### Sample descriptives of all subjects
```{r sample descriptives}
# gather info on both meds and no meda
# remove patients with more than 14 days apart PHQ and PCL
summary(pclAll$AGE_OCT01)
mean(pclAll$AGE_OCT01, na.rm=TRUE)
sd(pclAll$AGE_OCT01, na.rm=TRUE)
summary(pclAll$BPCLTOT)
mean(pclAll$BPCLTOT)
sd(pclAll$BPCLTOT)
table(pclAll$FEMALE)
```

```{r}
# build data set only with PCL items
pclItems <- dplyr::select(pclAll, starts_with("PCL"))

pclItems_noCluster <- dplyr::select(pclItems, -PCLFY, -PCLSURVEYDATE, -PCLRAWSCORE)
nrow(pclItems_noCluster)
# Exclude missings
pclItems_noCluster <- na.omit(pclItems_noCluster)
nrow(pclItems_noCluster)
```
<br/>
<br/>
## 3.  Compare different estimation techniques ####
#### We compare several models to set the one's we would use thorugh the rest of analysis
#### First we do it on the PCL items alone (whole 150k)
```{r}
# Rename dataset
df2 <- pclItems_noCluster

# Define labels
labels <- names(df2)

#### Three different methods to estimate GGMs
### A. Gaussian Graphical Model, regularized
n2 <- estimateNetwork(df2, default="EBICglasso", corMethod = "cor", corArgs = list(method="spearman"), threshold=FALSE)
g2 <- plot(n2, legend.cex=.5, vsize=7)
# Severely skewed data, so we use Spearman over polychoric correlations here, as recommended (https://psycnet.apa.org/record/2018-13501-001)

### B. Gaussian Graphical Model, regularized & thresholded
n3 <- estimateNetwork(df2, default="EBICglasso", corMethod = "cor", corArgs = list(method="spearman"), threshold=TRUE)
g3 <- plot(n3, layout=g2$layout, legend.cex=.5, vsize=7)

### C. Robustness: use new estimation procedure ggmModSelect (http://psychosystems.org/qgraph_1.5)
n4 <- estimateNetwork(df2, default="ggmModSelect", corMethod = "cor", corArgs = list(method="spearman"))
g4 <- plot(n4, layout=g2$layout, legend.cex=.5, vsize=7)
```

#### Correlate the different networks with the first network (EBIC, spearman) to check similarity
```{r}
cor(vechs(n2$graph), vechs(n4$graph)) # 0.997
cor(vechs(n2$graph), vechs(n4$graph), method="spearman") # 0.993
cor(vechs(n2$graph), vechs(n3$graph), method="spearman") #0.99
cor(vechs(n4$graph), vechs(n3$graph), method="spearman") #0.989

# Looks like all networks are highly correlated with each other. 

# ## Plot network and save as PDF 
g2 <- plot(n2, pie=R2_1, title="PCL-Network", legend.cex=.5, vsize=7)

```

<br/><br/>
<br/><br/>
## 4. Estiamte Networks incl. centrality and stability analyses ####
```{r network_pcl}
# Define 5-factor PTSD model following: Harpaz-Rotem, I., Tsai, J., Pietrzak, R. H., & Hoff, R. (2014).
gr1 <- list("Re-experiencing"=c(1:5), "Avoidance"=c(6:7), "Emotional numbing"=c(8:12),
            "Dysphoric arousal"=c(13:15), "Anxious arousal"=c(16:17)) 
# Define DSM PTSD model
gr_likeDSM <- list("Intrusion"=c(1:5), "Avoidance"=c(6:12), "Arousal"=c(13:17)) #PTSD symptoms categories B C D

#Plot & Save Networks
pdf("PCL_NW_5_factor.pdf", width=5, height=5)
g2 <- plot(n2, pie=R2_1, legend.cex=.5, vsize=7, theme = "colorblind", groups = gr1)
dev.off()

pdf("PCL_NW_DSM_factor.pdf", width=5, height=5)
g3 <- plot(n2, pie=R2_1, legend.cex=.5, vsize=7, theme = "colorblind", groups = gr_likeDSM)
dev.off()

#### Centrality Analyses
# sort by level of centrality (strength)
sort(centrality(n2)$OutDegree, decreasing = T) ## TOBIAS: I am not sure if "outdegree" is equal to strength in this case
# plot centrality
centralityPlot(n2, include = "all")

#### Stability of PCL network

# Non-parametric bootstrap
# Bootstrap 1:
boot1 <- bootnet(n2, nCores = 6, nBoots = 1000, type = "nonparametric") 
plot(boot1, labels = F, order = "sample")  + theme_minimal()
# Case-dropping bootstrap
boot2 <- bootnet(n2, nCores = 6, nBoots = 1000, type = "case")
plot(boot2, labels = F, order = "sample") + theme_minimal()

# Egde sigficance testing
pdf("PCL_edge_sig.pdf", width=5, height=5)
plot(boot1, "edge", plot = "difference", onlyNonZero = TRUE, order = "sample")
dev.off()

# Strength significance testing
pdf("PCL_strength_sig.pdf", width=5, height=5)
plot(boot1, "Strength")
dev.off()
```

## 5. Community Analysis ####
#### Data driven clustering using EGA
```{r}
### use EGA to find clusters using to diff. models
## Glasso model
# EGA
egaPCL_glasso<-EGA(df2, plot.EGA = TRUE, steps = 4,  model = "glasso")
# plot EGA
plot(egaPCL_glasso, theme = "colorblind", layout =g2$layout)
# CFA based on EGA clustered NW
pclCFA_glasso <- CFA(ega.obj = egaPCL_glasso,data = df2,plot.CFA = TRUE, estimator = "WLSMV")
# plot CFA 
plot(pclCFA_glasso, theme="colorblind")
# bootversion
bootEGA_pcl <- bootEGA(df2, 500, type = "resampling", ncores = 5)
# plot bootversion
plot(bootEGA_pcl)


## TMFG model
# EGA
egaPCL_TMFG<-EGA(df2, plot.EGA = TRUE, steps = 4,  model = "TMFG")
# CFA based on EGA clustered NW
pclCFA_TMFG <- CFA(ega.obj = egaPCL_TMFG,data = df2,plot.CFA = TRUE, estimator = "WLSMV")
```



## 6. Confirmatory analyses ####
# TOBIAS: I would suggest the following steps:
# 1. Define all models: A: Network (GGM), B: Factor-models (DSM, five-factor model, EGA-model), C: Latent networks (DSM, five-factor model, EGA-model)
# 2. Estimate all fit indices using "psychonetrics" package
# 3. Plot all models

#### We randomly sample 50% of population and run the model, then fit on the other 50%
<br/><br/>
<br/><br/>
### 5.1 PCL Network
#### Split Data into Training and Testing in R 
  
  ```{r}
sample_size = floor(0.5*nrow(pclItems_noCluster))
set.seed(777)

# randomly split data in r
picked = sample(seq_len(nrow(pclItems_noCluster)),size = sample_size)
train =pclItems_noCluster[picked,]
test =pclItems_noCluster[-picked,]

# Start run confirmatory analysis
# run model on half the subjects 
# shuold we consider comparing fit of different sets of models? or is it too much?
# TOBIAS: We could, although given the sample, they will converge anyhow.


#net <-  estimateNetwork(train, default="EBICglasso", corMethod = "cor", corArgs = list(method="spearman"), threshold=FALSE)
net <- estimateNetwork(train, default = "ggmModSelect", verbose = FALSE)
network <- 1*(net$graph != 0)
model_frombootnet <- ggm(train, omega = network) %>% runmodel
```

#### Run analysis
```{r}
adjacency <- network #1*(getmatrix(model_frombootnet, "omega")!=0)
confirmatory <- ggm(test, omega = adjacency)
confirmatory <- confirmatory %>% runmodel

confirmatory %>% fit
```
```{r}
# saving to word table
library(rtf)
rtffile <- RTF("fitResults.doc")  # this can be an .rtf or a .doc
addParagraph(rtffile, "This is the output of fit results:\n")
addTable(rtffile, as.data.frame((confirmatory %>% fit)))
done(rtffile)
```

#### Compare fit indices
```{r}
compare(train = model_frombootnet , test = confirmatory)
```


### Only PCL has three clusters (when EGA load is set to 0.7 )
## We should compare the confirmatory analysis of PTSD (PCL) based on the EGA with one based on the 5-factor model

```{r}
# gr1 <- list("Re-experiencing"=c(1:5), "Avoidance"=c(6:7), "Emotional numbing"=c(8:12),"Dysphoric arousal"=c(13:15), "Anxious arousal"=c(16:17))
model_5Factor <- ' ReExperiencing =~ PCL1 + PCL2 + PCL3 + PCL4 + PCL5
                        Avoidance =~ PCL6 + PCL7
                          Numbing =~ PCL8 + PCL9 + PCL10 + PCL11 + PCL12
                 DysphoricArousal =~ PCL13 + PCL14 + PCL15
                   AnxiousArousal =~ PCL16 + PCL17 '
theoModel <- cfa(model_5Factor, data = df2, estimator = "WLSMV")

# fit measures of 5 factor model
fitMeasures(theoModel, c("chisq","df","pvalue","srmr","cfi","rmsea")) #cave: these are not "robust" measures
# fit measures of EGA
fitMeasures(pclCFA_glasso$fit, c("chisq","df","pvalue","srmr","cfi","rmsea"))
# seems like 5 models has a bit better fit
fitMeasures(pclCFA_TMFG$fit, c("chisq","df","pvalue","srmr","cfi","rmsea"))

# seems like TMGF is the worst option

# Lets run Chisq to compare each model

lavTestLRT(theoModel,pclCFA_TMFG$fit)
lavTestLRT(theoModel,pclCFA_glasso$fit)
```
## Lets plot the theoretical modeling, just for the sake of plotting
```{r}
semPlot::semPaths(theoModel, what = "est", layout = "spring", theme = "colorblind")#, title = FALSE, curvePivot = TRUE)
```
## We can next compare it with the DSM-IV model (3 factors)
```{r}
#gr_likeDSM <- list("Intrusion"=c(1:5), "Avoidance"=c(6:12), "Arousal"=c(13:17)) #PTSD symptoms categories B C D
dsm_Model <- 'Intrusion =~ PCL1 + PCL2 + PCL3 + PCL4 + PCL5 
              Avoidance =~ PCL6 + PCL7 + PCL8 + PCL9 + PCL10 + PCL11 + PCL12
                Arousal =~ PCL13 + PCL14 + PCL15 + PCL16 + PCL17'

DSMModel <- cfa(dsm_Model, data = df2, estimator = "WLSMV")
fitMeasures(DSMModel, c("chisq","df","pvalue","srmr","cfi","rmsea")) # cave again: these are not robust measures
lavTestLRT(theoModel,DSMModel)
lavTestLRT(DSMModel,pclCFA_glasso$fit, method ="satorra.2000")
```
# 5-factor model outperform theoretical model. 



# ---------------------------------------------------------------------------------------
# ------------- KIs additions: LNM using psychonetrics ----------------------------------
# ------------- this is from another script, have done some crude adaptations------------
# ------------- based on the 5-factor model----------------------------------------------
# ---------------------------------------------------------------------------------------

## Latent Networks
###----------------------------- 5 factor model --------------------------------------###
# Define the factors (based on the models above): 
Latents_5_factor<-c("ReExperiencing", "Avoidance", "Numbing", "DysphoricArousal", "AnxiousArousal")

# Lambda (based on same factor model)
# There are more elegant ways, but here's the lambda matrix...
Lambda_5_factor <- matrix(0,17,5)
Lambda_5_factor[1:5,1] <- 1
Lambda_5_factor[6:7,2] <- 1
Lambda_5_factor[8:12,3] <- 1
Lambda_5_factor[13:15, 4] <- 1
Lambda_5_factor[16:17,5] <- 1

# Run model
lnmMod_5_factor <- lnm(train, lambda = Lambda_5_factor, 
              latents = Latents_5_factor, identification = "variance", latent = "ggm")

# Remove non-sig latent edge:
lnmMod_5_factor <- lnmMod_5_factor %>% runmodel %>% prune(alpha = 0.05)

# Check it out: 
lnmMod_5_factor
lnmMod_5_factor %>% parameters
lnmMod_5_factor %>% MIs

# Plot it:
# Different options for plotting, can be changed
qgraph(lnmMod@modelmatrices[[1]]$omega_zeta, labels = Latents,
       theme = "colorblind", vsize = 10)

# Prune
lnmMod_5_factorPruned<-lnmMod_5_factor %>% prune(alpha = 0.05)
lnmMod_5_factorPruned %>% parameters

###----------------------------- DSM 4 factor model --------------------------------------###
# Define the factors (based on the models above): 
Latents_DSM <- c("Intrusion", "Avoidance", "Arousal")

# Lambda (based on same factor model)
# There are more elegant ways, but here's the lambda matrix...
Lambda_DSM <- matrix(0,17,4)
Lambda_DSM[1:5,1] <- 1
Lambda_DSM[6:12,2] <- 1
Lambda_DSM[13:17,3] <- 1

# Run model
lnmMod_DSM <- lnm(train, lambda = Lambda_DSM, 
                       latents = Latents_DSM, identification = "variance", latent = "ggm")

# Remove non-sig latent edge:
lnmMod_DSM <- lnmMod_DSM %>% runmodel %>% prune(alpha = 0.05)

# Check it out: 
lnmMod_DSM
lnmMod_DSM %>% parameters
lnmMod_DSM %>% MIs

# Plot it:
# Different options for plotting, can be changed
qgraph(lnmMod__DSM@modelmatrices[[1]]$omega_zeta, labels = Latents,
       theme = "colorblind", vsize = 10)

# Prune
lnmMod_DSMPruned<-lnmMod_DSM %>% prune(alpha = 0.05)
lnmMod_DSMPruned %>% parameters

## Latent Networks
###----------------------------- EGA model --------------------------------------###
# Define the factors (based on the EGA above): 
#
#
#
#
#




###----------------------------- CONFIRMATORY TESTS --------------------------------------###
# Confirmatory on the test set
# Something's rotten, estimates out of bound, needs to be checked and rewritten  - TOBIAS: hard to test without the data
matrixConfirm<-lnmMod@modelmatrices[[1]]$omega_zeta
LambdaLNM <- lnmMod@modelmatrices[[1]]$lambda
confirmatoryLNM <- lvm(test,lambda = LambdaLNM, omega_zeta = matrixConfirm)
confirmatoryLNM <- confirmatoryLNM %>% runmodel

# Show fit
confirmatoryLNM %>% fit


## 7. Session info
```{r}
session_info()
```
<br/><br/>
<br/><br/>
# 8. Open Questions
# TOBIAS: 1. I am not sure, if we need to estiamte different GGMs. This will add further complexity to the analyses, 
#             but I am not sure if anything is gained from it. I would suggest, we will just define, which estimation techique to use.
#         2. Which fit indices should we use? Currently, these are not "robust". But I lack the experience, to tell if this is important.          
